name: Release2

on:
  workflow_dispatch:

concurrency: Release

jobs:
  set-release-version:
    if: github.repository_owner == 'Informatievlaanderen'
    name: Decide next version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
          persist-credentials: false

    - name: Setup Node.js
      uses: actions/setup-node@v3.5.1

    - name: Node version
      shell: bash
      run: node --version

    - name: Install NPM dependencies
      shell: bash
      run: npm ci

    - name: Run Semantic Release Dry-Run
      shell: bash
      run: npx semantic-release --dry-run
      env:
        BUILD_DOCKER_REGISTRY: ${{ secrets.VBR_BUILD_DOCKER_REGISTRY_TST }}
        GITHUB_TOKEN: ${{ secrets.VBR_GIT_RELEASE_TOKEN }}
        GIT_COMMIT: ${{ github.sha }}
        GIT_USERNAME: ${{ secrets.VBR_GIT_USER }}
        GIT_AUTHOR_NAME: ${{ secrets.VBR_GIT_USER }}
        GIT_COMMITTER_NAME: ${{ secrets.VBR_GIT_USER }}
        GIT_EMAIL: ${{ secrets.VBR_GIT_EMAIL }}
        GIT_AUTHOR_EMAIL: ${{ secrets.VBR_GIT_EMAIL }}
        GIT_COMMITTER_EMAIL: ${{ secrets.VBR_GIT_EMAIL }}

    - name: Set Release Version
      id: set-version
      run: |
        [ ! -f semver ] && echo none > semver
        echo $(cat semver)
        echo ::set-output name=version::$(cat semver)
        echo RELEASE_VERSION=$(cat semver) >> $GITHUB_ENV
      shell: bash

  build-api-backoffice:
    name: Build Api BackOffice
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_ApiBackOffice
      image-file: sr-api-backoffice-image.tar
      image-name: api-backoffice
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.BackOffice
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-api-legacy:
    name: Build Api Legacy
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_ApiLegacy
      image-file: sr-api-legacy-image.tar
      image-name: api-legacy
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.Legacy
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-api-oslo:
    name: Build Api Oslo
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_ApiOslo
      image-file: sr-api-oslo-image.tar
      image-name: api-oslo
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.Oslo
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-api-crab-import:
    name: Build Api CrabImport
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_ApiCrabImport
      image-file: sr-api-crab-import-image.tar
      image-name: api-crab-import
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.CrabImport
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-api-extract:
    name: Build Api Extract
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_ApiExtract
      image-file: sr-api-extract-image.tar
      image-name: api-extract
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.Extract
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-projector:
    name: Build Projector
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_Projector
      image-file: sr-projector-image.tar
      image-name: projector
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Projector
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-projections-backoffice:
    name: Build Projections BackOffice
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_ProjectionsBackOffice
      image-file: sr-projections-backoffice-image.tar
      image-name: projections-backoffice
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Projections.BackOffice
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-projections-syndication:
    name: Build Projections Syndication
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_ProjectionsSyndication
      image-file: sr-projections-syndication-image.tar
      image-name: projections-syndication
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Projections.Syndication
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-consumer:
    name: Build Consumer
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_Consumer
      image-file: sr-consumer-image.tar
      image-name: consumer
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Consumer
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-producer:
    name: Build Producer
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_Producer
      image-file: sr-producer-image.tar
      image-name: producer
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Producer
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-producer-snapshot-oslo:
    name: Build Producer Snapshot Oslo
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_ProducerSnapshotOslo
      image-file: sr-producer-snapshot-oslo-image.tar
      image-name: producer-snapshot-oslo
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Producer.Snapshot.Oslo
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  build-migrator-streetname:
    name: Build Migrator StreetName
    uses: ./.github/workflows/build-image.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      build-target: Containerize_MigratorStreetName
      image-file: sr-migrator-streetname-image.tar
      image-name: migrator-streetname
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Migrator.StreetName
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  pack-api-backoffice:
    name: Pack Api BackOffice
    uses: ./.github/workflows/pack.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      pack-file: Be.Vlaanderen.Basisregisters.StreetNameRegistry.Api.BackOffice
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.BackOffice
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  pack-api-backoffice-abstractions:
    name: Pack Api BackOffice Abstractions
    uses: ./.github/workflows/pack.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      pack-file: Be.Vlaanderen.Basisregisters.StreetNameRegistry.Api.BackOffice.Abstractions
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.BackOffice.Abstractions
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  pack-api-legacy:
    name: Pack Api Legacy
    uses: ./.github/workflows/pack.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      pack-file: Be.Vlaanderen.Basisregisters.StreetNameRegistry.Api.Legacy
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.Legacy
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  pack-api-oslo:
    name: Pack Api Oslo
    uses: ./.github/workflows/pack.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      pack-file: Be.Vlaanderen.Basisregisters.StreetNameRegistry.Api.Oslo
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.Oslo
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  pack-api-extract:
    name: Pack Api Extract
    uses: ./.github/workflows/pack.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      pack-file: Be.Vlaanderen.Basisregisters.StreetNameRegistry.Api.Extract
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.Extract
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  pack-api-crab-import:
    name: Pack Api CrabImport
    uses: ./.github/workflows/pack.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      pack-file: Be.Vlaanderen.Basisregisters.StreetNameRegistry.Api.CrabImport
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Api.CrabImport
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit

  pack-projector:
    name: Pack Projector
    uses: ./.github/workflows/pack.yml
    needs: [ set-release-version ]
    if: ${{ (github.repository_owner == 'Informatievlaanderen') && (needs.set-release-version.outputs.version != 'none') }}
    with:
      pack-file: Be.Vlaanderen.Basisregisters.StreetNameRegistry.Projector
      test-project: StreetNameRegistry.Tests
      build-project: StreetNameRegistry.Projector
      semver: ${{ needs.set-release-version.outputs.version }}
    secrets: inherit
